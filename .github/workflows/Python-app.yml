name: Build Qt Application - Optimized

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  build:
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: "3.11"

    - name: Install dependencies (PowerShell-safe)
      shell: pwsh
      run: |
        python -m pip install --upgrade pip
        if (Test-Path -Path "requirements.txt") {
          pip install -r requirements.txt
        } else {
          Write-Host "No requirements.txt found"
        }
        # Aseguramos las libs necesarias
        pip install pyinstaller PySide6 requests

    - name: Install UPX (to compress binaries)
      # UPX will help reduce size of binary files that PyInstaller produces.
      shell: pwsh
      run: |
        $upxzip = "$env:RUNNER_TEMP\upx.zip"
        Invoke-WebRequest -Uri "https://github.com/upx/upx/releases/download/v4.0.2/upx-4.0.2-win64.zip" -OutFile $upxzip
        Expand-Archive -LiteralPath $upxzip -DestinationPath "$env:RUNNER_TEMP\upxdir"
        # Find upx.exe path and expose as env var for PyInstaller
        $upxpath = (Get-ChildItem "$env:RUNNER_TEMP\upxdir" -Recurse -Filter upx.exe | Select-Object -First 1).FullName
        Write-Host "UPX found at: $upxpath"
        echo "UPX_PATH=$upxpath" | Out-File -FilePath upx_env.txt -Encoding utf8
      # we will read the path in the next step

    - name: Build executable (one-dir, optimized)
      working-directory: Ventana_Principal_TFG
      shell: pwsh
      env:
        # read the UPX path we extracted before (fallback empty)
        UPX_PATH: ${{ steps.install_upx.outputs.upx_path }}
      run: |
        # GET UPX PATH from the temp file created in previous step (if exists)
        $upxenvfile = "$env:GITHUB_WORKSPACE\upx_env.txt"
        if (Test-Path -Path $upxenvfile) {
          $u = Get-Content $upxenvfile -Raw
          if ($u -match "UPX_PATH=(.+)") { $UPX = $Matches[1].Trim() } else { $UPX = "" }
        } else {
          # try scanning runner temp
          $UPX = (Get-ChildItem "$env:RUNNER_TEMP\upxdir" -Recurse -Filter upx.exe -ErrorAction SilentlyContinue | Select-Object -First 1).FullName
        }
        Write-Host "Using UPX: $UPX"
        # Build in one-dir mode (no --onefile). One-dir opens MUCH faster on startup.
        # Exclude typical unused modules to reduce noise.
        $pyinst_cmd = "python -m PyInstaller main.py --noconsole --name Launcher_Videojuego --hidden-import requests --hidden-import PySide6 --hidden-import PySide6.QtCore --hidden-import PySide6.QtGui --hidden-import PySide6.QtWidgets --collect-all PySide6 --strip --clean --exclude-module tkinter --exclude-module matplotlib --exclude-module test --exclude-module pytest"
        if ($UPX -and (Test-Path $UPX)) {
          $pyinst_cmd += " --upx-dir `"$($UPX | Split-Path -Parent)`""
        }
        Write-Host "Running: $pyinst_cmd"
        iex $pyinst_cmd

        Write-Host "----- LISTADO DE DIST/Launcher_Videojuego (ordenado por tama√±o) -----"
        if (Test-Path -Path dist\Launcher_Videojuego) {
          Get-ChildItem -Path dist\Launcher_Videojuego -Recurse | Sort-Object Length -Descending | Select-Object FullName, @{Name='MB';Expression={[Math]::Round($_.Length/1MB,2)}} | Format-Table -AutoSize
        } else {
          Write-Host "dist\\Launcher_Videojuego no encontrado (Revisa output de PyInstaller)"
        }

    - name: Upload artifact (one-dir folder)
      uses: actions/upload-artifact@v4
      with:
        name: Launcher_Videojuego_dist
        path: Ventana_Principal_TFG/dist/Launcher_Videojuego/**

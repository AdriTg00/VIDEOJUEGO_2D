name: Combine Launcher and Godot Builds

on:
  workflow_run:
    workflows:
      - Python application
      - Build Godot Windows EXE
    types:
      - completed

jobs:
  combine:
    # Solo ejecutar cuando AMBOS han terminado con Ã©xito
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: windows-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -----------------------------
    # Descargar Launcher
    # -----------------------------
    - name: Download Launcher artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: Python-app.yml
        name: Launcher_Videojuego_exe
        path: tmp/launcher
        branch: main

    # -----------------------------
    # Descargar Godot Game
    # -----------------------------
    - name: Download Godot artifact
      uses: dawidd6/action-download-artifact@v2
      with:
        workflow: build_godot.yml
        name: windows-build
        path: tmp/game
        branch: main

    # -----------------------------
    # Crear estructura final
    # -----------------------------
    - name: Create Dist structure
      run: |
        mkdir Dist
        mkdir Dist\game
        mkdir Dist\runtime
        mkdir Dist\config
        mkdir Dist\saves

    # -----------------------------
    # Copiar Launcher
    # -----------------------------
    - name: Copy Launcher
      run: |
        copy tmp\launcher\*.exe Dist\Launcher.exe

    # -----------------------------
    # Copiar Juego
    # -----------------------------
    - name: Copy Godot game
      run: |
        copy tmp\game\*.exe Dist\game\Juego.exe
        copy tmp\game\*.pck Dist\game\Juego.pck

    # -----------------------------
    # Usuario (si existe)
    # -----------------------------
    - name: Create user config
      shell: powershell
      run: |
        if (Test-Path "usuario_local.json") {
          Copy-Item "usuario_local.json" "Dist\config\usuario_local.json"
        } else {
          '{}' | Out-File "Dist\config\usuario_local.json" -Encoding utf8
        }

    # -----------------------------
    # Subir paquete final
    # -----------------------------
    - name: Upload Dist Package
      uses: actions/upload-artifact@v4
      with:
        name: Dist_Package
        path: Dist
